- name: install dependencies
  apt:
    update_cache: yes
    name:
      - wget
      - tar
    state: present

- name: install prometheus
  shell: |
    id prometheus || useradd --no-create-home --shell /usr/sbin/nologin prometheus
    curl -L https://github.com/prometheus/prometheus/releases/download/v2.55.1/prometheus-2.55.1.linux-amd64.tar.gz | tar xz
    cp prometheus-2.55.1.linux-amd64/prometheus /usr/local/bin/
    mkdir -p /etc/prometheus /var/lib/prometheus
    cat >/etc/prometheus/prometheus.yml <<'EOF'
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: node
        static_configs:
          - targets: ['10.20.1.10:9100','10.20.2.10:9100']
      - job_name: nginx_logs
        static_configs:
          - targets: ['10.20.1.10:4040','10.20.2.10:4040']
    EOF
    cat >/etc/systemd/system/prometheus.service <<'EOF'
    [Unit]
    Description=Prometheus
    After=network-online.target
    [Service]
    User=prometheus
    ExecStart=/usr/local/bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus
    Restart=on-failure
    [Install]
    WantedBy=multi-user.target
    EOF
    systemctl daemon-reload
    systemctl enable --now prometheus
